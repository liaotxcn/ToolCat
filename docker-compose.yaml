version: '3.7'

# 定义网络
networks:
  weave-network:
    driver: bridge

# 定义卷
volumes:
  mysql-data:
    driver: local
  logs:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  nginx-config:
    driver: local
  nginx-logs:
    driver: local


# 定义服务
services:
  # Nginx负载均衡服务
  nginx:
    image: nginx:alpine
    container_name: weave-nginx
    restart: unless-stopped
    networks:
      - weave-network
    ports:
      - "80:80"      # HTTP入口
      - "443:443"     # HTTPS入口（可选）
      - "8080:8080"   # Nginx状态页面
    volumes:
      - nginx-config:/etc/nginx/conf.d
      - nginx-logs:/var/log/nginx
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/weave.conf:/etc/nginx/conf.d/weave.conf:ro
    depends_on:
      - weave-1
      - weave-2
      - weave-3
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/nginx_status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Weave应用服务 - 实例1
  weave-1:
    build: .
    container_name: weave-app-1
    restart: unless-stopped
    networks:
      - weave-network
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
      - INSTANCE_ID=weave-1
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USERNAME=weave_user
      - DB_PASSWORD=${DB_PASSWORD:-default_password}
      - DB_NAME=weave
      - DB_CHARSET=utf8mb4
      - REDIS_ADDR=redisearch:6379
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret}
      - JWT_ACCESS_TOKEN_EXPIRY=60
      - JWT_REFRESH_TOKEN_EXPIRY=168
      - CSRF_ENABLED=true
      - CSRF_COOKIE_NAME=XSRF-TOKEN
      - CSRF_HEADER_NAME=X-CSRF-Token
      - LOG_LEVEL=info
      - LOG_OUTPUT_PATH=/app/logs/output.log
      - LOG_ERROR_PATH=/app/logs/error.log
    depends_on:
      - mysql
      - redisearch
    volumes:
      - logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8081/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Weave应用服务 - 实例2
  weave-2:
    build: .
    container_name: weave-app-2
    restart: unless-stopped
    networks:
      - weave-network
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
      - INSTANCE_ID=weave-2
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USERNAME=weave_user
      - DB_PASSWORD=${DB_PASSWORD:-default_password}
      - DB_NAME=weave
      - DB_CHARSET=utf8mb4
      - REDIS_ADDR=redisearch:6379
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret}
      - JWT_ACCESS_TOKEN_EXPIRY=60
      - JWT_REFRESH_TOKEN_EXPIRY=168
      - CSRF_ENABLED=true
      - CSRF_COOKIE_NAME=XSRF-TOKEN
      - CSRF_HEADER_NAME=X-CSRF-Token
      - LOG_LEVEL=info
      - LOG_OUTPUT_PATH=/app/logs/output.log
      - LOG_ERROR_PATH=/app/logs/error.log
    depends_on:
      - mysql
      - redisearch
    volumes:
      - logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8082/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Weave应用服务 - 实例3
  weave-3:
    build: .
    container_name: weave-app-3
    restart: unless-stopped
    networks:
      - weave-network
    ports:
      - "8083:8083"
    environment:
      - SERVER_PORT=8083
      - INSTANCE_ID=weave-3
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USERNAME=weave_user
      - DB_PASSWORD=${DB_PASSWORD:-default_password}
      - DB_NAME=weave
      - DB_CHARSET=utf8mb4
      - REDIS_ADDR=redisearch:6379
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret}
      - JWT_ACCESS_TOKEN_EXPIRY=60
      - JWT_REFRESH_TOKEN_EXPIRY=168
      - CSRF_ENABLED=true
      - CSRF_COOKIE_NAME=XSRF-TOKEN
      - CSRF_HEADER_NAME=X-CSRF-Token
      - LOG_LEVEL=info
      - LOG_OUTPUT_PATH=/app/logs/output.log
      - LOG_ERROR_PATH=/app/logs/error.log
    depends_on:
      - mysql
      - redisearch
    volumes:
      - logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8083/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # MySQL数据库服务
  mysql:
    # 使用官方MySQL镜像
    image: mysql:8.0
    # 容器名称
    container_name: weave-mysql
    # 重启策略
    restart: unless-stopped
    # 网络配置
    networks:
      - weave-network
    # 端口映射 (可选，仅当需要从主机直接访问数据库时启用)
    # ports:
    #   - "3306:3306"
    # 环境变量配置
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
      - MYSQL_DATABASE=weave
      - MYSQL_USER=weave_user
      - MYSQL_PASSWORD=${DB_PASSWORD:-default_password}
    # 卷挂载 (数据持久化)
    volumes:
      - mysql-data:/var/lib/mysql
      # 可选：初始化脚本
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    # 健康检查
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "--password=${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # 默认启用，如需禁用可通过docker-compose命令参数控制
    # 示例: docker-compose up -d --scale mysql=0 postgres
  
  # Redis服务
  redisearch:
    image: redis/redis-stack:latest
    container_name: weave-redis
    networks:
      - weave-network
    ports:
      - "6379:6379"  # Redis port
      - "8001:8001"  # RedisInsight port
    volumes:
      - redis-data:/data
    environment:
      - REDIS_ARGS=--dir /data --appendonly no --save 1800 1
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # PostgreSQL数据库服务（可选）
  postgres:
    # 使用官方PostgreSQL镜像
    image: postgres:15
    # 容器名称
    container_name: weave-postgres
    # 重启策略
    restart: unless-stopped
    # 网络配置
    networks:
      - weave-network
    # 端口映射 (可选，仅当需要从主机直接访问数据库时启用)
    # ports:
    #   - "5432:5432"
    # 环境变量配置
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_USER=${DB_USERNAME:-weave_user}
      - POSTGRES_DB=weave
    # 卷挂载 (数据持久化)
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # 可选：初始化脚本
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-weave_user} -d weave"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # 默认禁用，如需启用可通过docker-compose命令参数控制
    # 示例: docker-compose up -d --scale mysql=0 postgres

  # Prometheus监控服务
  prometheus:
    image: prom/prometheus:latest
    container_name: weave-prometheus
    restart: unless-stopped
    networks:
      - weave-network
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus
      - ./pkg/metrics/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    depends_on:
      - weave

  # Grafana可视化服务
  grafana:
    image: grafana/grafana:latest
    container_name: weave-grafana
    restart: unless-stopped
    networks:
      - weave-network
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    depends_on:
      - prometheus


# 使用说明：
# 1. 创建.env文件，设置以下环境变量（可选但推荐）：
#    DB_PASSWORD=your_secure_password
#    JWT_SECRET=your_secure_jwt_secret
#    MYSQL_ROOT_PASSWORD=your_root_password
# 
# 2. 启动服务：
#    docker-compose up -d
# 
# 3. 停止服务：
#    docker-compose down
# 
# 4. 查看日志：
#    docker-compose logs -f weave-app
#    docker-compose logs -f weave-mysql
# 
# 5. 进入容器：
#    docker-compose exec weave-app /bin/sh
#    docker-compose exec weave-mysql mysql -u root -p
# 
# 6. 查看服务状态：
#    docker-compose ps
# 
# 7. 构建并重新启动服务：
#    docker-compose up --build -d