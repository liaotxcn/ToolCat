<div class="format-converter-plugin">
  <!-- æ’ä»¶æ ‡é¢˜å’Œæè¿° -->
  <div class="plugin-header">
    <h2 class="plugin-title">æ ¼å¼è½¬æ¢å™¨</h2>
    <p class="plugin-desc">æ”¯æŒJSONã€YAMLå’ŒProtobufæ ¼å¼ä¹‹é—´çš„ç›¸äº’è½¬æ¢</p>
  </div>

  <!-- è½¬æ¢æ§åˆ¶åŒºåŸŸ -->
  <div class="conversion-controls">
    <div class="conversion-selector">
      <label for="conversion-type">è½¬æ¢ç±»å‹:</label>
      <select id="conversion-type" class="conversion-dropdown">
        <option value="json-to-yaml">JSON â†’ YAML</option>
        <option value="yaml-to-json">YAML â†’ JSON</option>
        <option value="json-to-protobuf">JSON â†’ Protobuf (Base64)</option>
        <option value="protobuf-to-json">Protobuf (Base64) â†’ JSON</option>
      </select>
      <button id="example-data-btn" class="btn-secondary">ç¤ºä¾‹æ•°æ®</button>
    </div>
    
    <button id="convert-btn" class="btn-primary">æ‰§è¡Œè½¬æ¢</button>
  </div>

  <!-- ç¼–è¾‘å™¨å’Œç»“æœåŒºåŸŸ -->
  <div class="editor-container">
    <div class="editor-section">
      <div class="editor-header">
        <h3>è¾“å…¥</h3>
        <button id="clear-input-btn" class="btn-icon" title="æ¸…ç©ºè¾“å…¥">ğŸ—‘ï¸</button>
      </div>
      <div class="validation-result" id="input-validation"></div>
      <textarea id="input-textarea" placeholder="è¯·è¾“å…¥è¦è½¬æ¢çš„æ•°æ®..." rows="15"></textarea>
    </div>
    
    <div class="swap-arrow">â‡„</div>
    
    <div class="editor-section">
      <div class="editor-header">
        <h3>è¾“å‡º</h3>
        <button id="copy-output-btn" class="btn-icon" title="å¤åˆ¶ç»“æœ">ğŸ“‹</button>
      </div>
      <div class="output-status" id="output-status"></div>
      <textarea id="output-textarea" placeholder="è½¬æ¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." rows="15" readonly></textarea>
    </div>
  </div>

  <!-- å†å²è®°å½•åŒºåŸŸ -->
  <div class="history-section">
    <div class="history-header">
      <h3>è½¬æ¢å†å²</h3>
      <button id="clear-history-btn" class="btn-icon" title="æ¸…ç©ºå†å²">ğŸ—‘ï¸</button>
    </div>
    <div id="history-list" class="history-list">
      <div class="no-history">æš‚æ— è½¬æ¢å†å²</div>
    </div>
  </div>

  <!-- å¸®åŠ©æç¤º -->
  <div class="help-section">
    <h4>ä½¿ç”¨è¯´æ˜</h4>
    <ul>
      <li>é€‰æ‹©è¦æ‰§è¡Œçš„è½¬æ¢ç±»å‹</li>
      <li>åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ç›¸åº”æ ¼å¼çš„æ•°æ®</li>
      <li>ç‚¹å‡»ã€Œæ‰§è¡Œè½¬æ¢ã€æŒ‰é’®å¼€å§‹è½¬æ¢</li>
      <li>ç‚¹å‡»ã€Œç¤ºä¾‹æ•°æ®ã€æŒ‰é’®å¯ä»¥åŠ è½½ç¤ºä¾‹å†…å®¹</li>
      <li>Protobufæ•°æ®å°†ä»¥Base64ç¼–ç çš„å½¢å¼æ˜¾ç¤ºå’Œè¾“å…¥</li>
    </ul>
  </div>

  <style>
    .format-converter-plugin {
      padding: var(--space-4);
      font-family: var(--font-family, system-ui);
    }

    .plugin-header {
      text-align: center;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--border-light);
    }

    .plugin-title {
      color: var(--primary-700);
      font-size: var(--font-size-2xl);
      margin: 0;
      font-weight: var(--font-weight-semibold);
    }

    .plugin-desc {
      color: var(--text-secondary);
      margin-top: var(--space-2);
    }

    .conversion-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      gap: var(--space-3);
    }

    .conversion-selector {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex: 1;
    }

    .conversion-selector label {
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
    }

    .conversion-dropdown {
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      font-size: var(--font-size-base);
      min-width: 200px;
      cursor: pointer;
      transition: var(--transition-all);
    }

    .conversion-dropdown:hover {
      border-color: var(--primary-400);
    }

    .conversion-dropdown:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-primary, .btn-secondary {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: var(--transition-all);
      border: none;
    }

    .btn-primary {
      background: var(--primary-600);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-700);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-medium);
    }

    .btn-icon {
      background: none;
      border: none;
      font-size: var(--font-size-lg);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-md);
      transition: background-color var(--transition-fast);
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
    }

    .editor-container {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      align-items: flex-start;
    }

    .editor-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .editor-header h3 {
      margin: 0;
      font-size: var(--font-size-lg);
      color: var(--text-primary);
    }

    #input-textarea, #output-textarea {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: var(--font-size-sm);
      line-height: 1.5;
      resize: vertical;
      background: var(--bg-primary);
      transition: var(--transition-all);
    }

    #input-textarea:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #output-textarea {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .swap-arrow {
      align-self: center;
      font-size: var(--font-size-2xl);
      color: var(--text-muted);
    }

    .validation-result, .output-status {
      margin-bottom: var(--space-2);
      font-size: var(--font-size-sm);
      min-height: 20px;
    }

    .validation-success {
      color: var(--success-600);
    }

    .validation-error {
      color: var(--error-600);
    }

    .history-section {
      margin-bottom: var(--space-6);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }

    .history-header h3 {
      margin: 0;
      font-size: var(--font-size-lg);
      color: var(--text-primary);
    }

    .history-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
    }

    .history-item {
      padding: var(--space-3);
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item:hover {
      background: var(--bg-primary);
    }

    .history-item-type {
      font-weight: var(--font-weight-medium);
      color: var(--primary-700);
    }

    .history-item-time {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      margin-left: var(--space-2);
    }

    .no-history {
      padding: var(--space-4);
      text-align: center;
      color: var(--text-muted);
    }

    .help-section {
      background: var(--bg-tertiary);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary-500);
    }

    .help-section h4 {
      margin-top: 0;
      margin-bottom: var(--space-2);
      color: var(--text-primary);
    }

    .help-section ul {
      margin: 0;
      padding-left: var(--space-6);
      color: var(--text-secondary);
    }

    .help-section li {
      margin-bottom: var(--space-1);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .editor-container {
        flex-direction: column;
      }
      
      .swap-arrow {
        transform: rotate(90deg);
        margin: var(--space-2) 0;
      }
      
      .conversion-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .conversion-selector {
        flex-direction: column;
        align-items: stretch;
      }
      
      .conversion-dropdown {
        min-width: auto;
      }
    }
  </style>

  <script>
    // è·å–DOMå…ƒç´ 
    const conversionType = document.getElementById('conversion-type');
    const inputTextarea = document.getElementById('input-textarea');
    const outputTextarea = document.getElementById('output-textarea');
    const convertBtn = document.getElementById('convert-btn');
    const clearInputBtn = document.getElementById('clear-input-btn');
    const copyOutputBtn = document.getElementById('copy-output-btn');
    const exampleDataBtn = document.getElementById('example-data-btn');
    const historyList = document.getElementById('history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const inputValidation = document.getElementById('input-validation');
    const outputStatus = document.getElementById('output-status');

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1åˆ†é’Ÿå†…
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // 1å°æ—¶å†…
        return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
      } else if (diff < 86400000) { // 24å°æ—¶å†…
        return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
      } else {
        return date.toLocaleString();
      }
    }

    // æ¸²æŸ“å†å²è®°å½•
    function renderHistory() {
      const history = plugin.getConversionHistory();
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="no-history">æš‚æ— è½¬æ¢å†å²</div>';
        return;
      }

      historyList.innerHTML = '';
      
      history.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div>
            <span class="history-item-type">${plugin.getConversionTypeName(item.type)}</span>
            <span class="history-item-time">${formatTime(item.timestamp)}</span>
          </div>
        `;
        
        historyItem.addEventListener('click', () => {
          // ç‚¹å‡»å†å²è®°å½•é¡¹æ—¶ï¼Œå¡«å……è¾“å…¥å’Œè¾“å‡º
          inputTextarea.value = item.input;
          outputTextarea.value = item.output;
          // è®¾ç½®å¯¹åº”çš„è½¬æ¢ç±»å‹
          conversionType.value = item.type;
          // éªŒè¯è¾“å…¥
          validateInput();
        });
        
        historyList.appendChild(historyItem);
      });
    }

    // éªŒè¯è¾“å…¥
    function validateInput() {
      const input = inputTextarea.value.trim();
      const type = conversionType.value;
      
      if (!input) {
        inputValidation.textContent = '';
        return;
      }

      try {
        if (type === 'json-to-yaml' || type === 'json-to-protobuf') {
          // éªŒè¯JSON
          JSON.parse(input);
          inputValidation.className = 'validation-result validation-success';
          inputValidation.textContent = 'âœ“ JSONæ ¼å¼æ­£ç¡®';
        } else if (type === 'yaml-to-json') {
          // å‰ç«¯ç®€å•éªŒè¯YAMLï¼ˆå®Œæ•´éªŒè¯åœ¨åç«¯ï¼‰
          if (input.includes(':') && !input.includes('{')) {
            inputValidation.className = 'validation-result validation-success';
            inputValidation.textContent = 'âœ“ YAMLæ ¼å¼åˆæ­¥æ£€æŸ¥é€šè¿‡';
          }
        } else if (type === 'protobuf-to-json') {
          // éªŒè¯Base64
          if (/^[A-Za-z0-9+/]+=*$/.test(input)) {
            inputValidation.className = 'validation-result validation-success';
            inputValidation.textContent = 'âœ“ Base64æ ¼å¼æ­£ç¡®';
          } else {
            inputValidation.className = 'validation-result validation-error';
            inputValidation.textContent = 'âœ— Base64æ ¼å¼é”™è¯¯';
          }
        }
      } catch (error) {
        inputValidation.className = 'validation-result validation-error';
        inputValidation.textContent = `âœ— æ ¼å¼é”™è¯¯: ${error.message}`;
      }
    }

    // æ˜¾ç¤ºè¾“å‡ºçŠ¶æ€
    function showOutputStatus(message, isError = false) {
      outputStatus.className = isError ? 'output-status validation-error' : 'output-status validation-success';
      outputStatus.textContent = message;
      
      // 3ç§’åæ¸…é™¤çŠ¶æ€
      setTimeout(() => {
        outputStatus.textContent = '';
      }, 3000);
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showOutputStatus('âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      } catch (error) {
        console.error('å¤åˆ¶å¤±è´¥:', error);
        showOutputStatus('âœ— å¤åˆ¶å¤±è´¥', true);
      }
    }

    // æ‰§è¡Œè½¬æ¢
    async function performConversion() {
      const input = inputTextarea.value.trim();
      const type = conversionType.value;
      
      if (!input) {
        showOutputStatus('âœ— è¯·è¾“å…¥æ•°æ®', true);
        return;
      }

      // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
      convertBtn.disabled = true;
      convertBtn.textContent = 'è½¬æ¢ä¸­...';
      outputStatus.textContent = '';

      try {
        let result;
        
        switch (type) {
          case 'json-to-yaml':
            result = await plugin.convertJsonToYaml(input);
            break;
          case 'yaml-to-json':
            result = await plugin.convertYamlToJson(input);
            break;
          case 'json-to-protobuf':
            result = await plugin.convertJsonToProtobuf(input);
            break;
          case 'protobuf-to-json':
            result = await plugin.convertProtobufToJson(input);
            break;
          default:
            throw new Error('ä¸æ”¯æŒçš„è½¬æ¢ç±»å‹');
        }

        outputTextarea.value = result;
        showOutputStatus('âœ“ è½¬æ¢æˆåŠŸ');
        renderHistory(); // æ›´æ–°å†å²è®°å½•
      } catch (error) {
        console.error('è½¬æ¢é”™è¯¯:', error);
        showOutputStatus(`âœ— ${error.message}`, true);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        convertBtn.disabled = false;
        convertBtn.textContent = 'æ‰§è¡Œè½¬æ¢';
      }
    }

    // åŠ è½½ç¤ºä¾‹æ•°æ®
    function loadExampleData() {
      const type = conversionType.value;
      let exampleData = '';
      
      if (type === 'json-to-yaml' || type === 'json-to-protobuf') {
        exampleData = plugin.getExampleData('json');
      } else if (type === 'yaml-to-json') {
        exampleData = plugin.getExampleData('yaml');
      } else if (type === 'protobuf-to-json') {
        // ä¸ºProtobufç¤ºä¾‹åŠ è½½ä¸€ä¸ªBase64ç¼–ç çš„ç®€å•æ•°æ®
        exampleData = 'Cg4KICAgICJuYW1lIjogIuS4jeW5uS4iLAogICAgInZlcnNpb24iOiAiMS4wLjAiLAogICAgImRlc2NyaXB0aW9uIjogIuWwveS7pe2UuaW4iLAogICAgImF1dGgiOiB7CiAgICAgICAgIm5hbWUiOiAi5YyF5aW9IiwKICAgICAgICAiZW1haWwiOiAiemhhbmdzYW5AZXhhbXBsZS5jb20iCiAgICB9LAogICAgInRhZ3MiOiBbIjXmnKzZgiIsICJ5YW1sIl0sCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICAgImNyZWF0ZWRBdCI6ICIyMDI0LTAxLTAxVDAwOjAwOjAwWiIsCiAgICAgICAgInVwZGF0ZWRBdCI6ICIyMDI0LTAxLTAxVDAwOjAwOjAwWiIKICAgIH0sCiAgICAiYWN0aXZlIjogdHJ1ZSwKICAgICJjb3VudCI6IDQyLAogICAgInNldHRpbmdzIjogewogICAgICAgICJ0aGVtZSI6ICJsaWdodCIsCiAgICAgICAgIm5vdGlmaWNhdGlvbnMiOiBmYWxzZQogICAgfQp9';
      }
      
      inputTextarea.value = exampleData;
      outputTextarea.value = '';
      validateInput();
    }

    // äº‹ä»¶ç›‘å¬å™¨
    conversionType.addEventListener('change', () => {
      // æ¸…é™¤è¾“å‡ºå’ŒçŠ¶æ€
      outputTextarea.value = '';
      outputStatus.textContent = '';
      inputValidation.textContent = '';
      // éªŒè¯å½“å‰è¾“å…¥
      validateInput();
    });

    inputTextarea.addEventListener('input', validateInput);
    convertBtn.addEventListener('click', performConversion);
    clearInputBtn.addEventListener('click', () => {
      inputTextarea.value = '';
      inputValidation.textContent = '';
    });
    
    copyOutputBtn.addEventListener('click', () => {
      const output = outputTextarea.value;
      if (output) {
        copyToClipboard(output);
      }
    });
    
    exampleDataBtn.addEventListener('click', loadExampleData);
    
    clearHistoryBtn.addEventListener('click', () => {
      plugin.clearHistory();
      renderHistory();
    });

    // åˆå§‹åŒ–
    renderHistory();
    validateInput();

    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + Enter æ‰§è¡Œè½¬æ¢
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        performConversion();
      }
    });
  </script>
</div>